var KnimeUIExtensionService=function(){"use strict";var e,i,t,s,n,a,r;!function(e){e.ERROR="error",e.WARN="warn"}(e||(e={}));class KnimeService{constructor(e=null,i=null,t=null){this.extensionConfig=e,this.callableService=i,this.callablePushNotification=t,this.notificationCallbacksMap=new Map}async callService(e){if(!this.extensionConfig){const e=this.createAlert({subtitle:"Missing extension config",message:"Cannot call service without extension config"});return this.sendError(e),Promise.resolve({})}if(!this.callableService){const e=this.createAlert({message:"Callable service is not available",subtitle:"Service not found"});return this.sendError(e),Promise.resolve({})}const i=await this.executeServiceCall(e),{error:t,result:s}=i||{};return t&&this.sendError(t),Promise.resolve({result:s})}executeServiceCall(e){return this.callableService(...e)}registerDataGetter(e){this.dataGetter=e}getData(){return Promise.resolve("function"==typeof this.dataGetter?this.dataGetter():null)}onServiceNotification(e){(this.notificationCallbacksMap.get(e.method)||[]).forEach((i=>{i(e)}))}addNotificationCallback(e,i){this.notificationCallbacksMap.set(e,[...this.notificationCallbacksMap.get(e)||[],i])}removeNotificationCallback(e,i){this.notificationCallbacksMap.set(e,(this.notificationCallbacksMap.get(e)||[]).filter((e=>e!==i)))}resetNotificationCallbacksByType(e){this.notificationCallbacksMap.set(e,[])}resetNotificationCallbacks(){this.notificationCallbacksMap.clear()}pushNotification(e){if(!this.extensionConfig){const e=this.createAlert({subtitle:"Missing extension config",message:"Cannot push notification without extension config"});return this.sendError(e),Promise.resolve({error:e})}if(!this.callablePushNotification){const e=this.createAlert({subtitle:"Push notification failed",message:"Push notification is not available"});return this.sendError(e),Promise.resolve({error:e})}return this.callablePushNotification(Object.assign({callerId:this.serviceId},e))}sendError(e){this.callablePushNotification?this.callablePushNotification({callerId:this.serviceId,alert:e,type:"alert"}):console.error(e)}sendWarning(e){this.callablePushNotification?this.callablePushNotification({callerId:this.serviceId,alert:e,type:"alert"}):console.warn(e)}createAlert(i){var t,s;const{type:n=e.ERROR,message:a,code:r,subtitle:o}=i;return{nodeId:(null===(t=this.extensionConfig)||void 0===t?void 0:t.nodeId)||"MISSING",nodeInfo:(null===(s=this.extensionConfig)||void 0===s?void 0:s.nodeInfo)||{},type:n,message:a,code:r,subtitle:o}}get serviceId(){const{nodeId:e,projectId:i,workflowId:t,extensionType:s}=this.extensionConfig||{};return`${e}.${i}.${t}.${s}`}}!function(e){e.CALL_NODE_DATA_SERVICE="NodeService.callNodeDataService",e.CALL_NODE_SELECTION_SERVICE="NodeService.updateDataPointSelection"}(i||(i={})),function(e){e.INITIAL_DATA="initial_data",e.DATA="data",e.APPLY_DATA="apply_data"}(t||(t={})),function(e){e.ADD="ADD",e.REMOVE="REMOVE",e.REPLACE="REPLACE"}(s||(s={})),function(e){e.DIALOG="dialog",e.VIEW="view"}(n||(n={})),function(e){e.DataEvent="DataEvent",e.SelectionEvent="SelectionEvent"}(a||(a={})),function(e){e.HTML="HTML",e.VUE_COMPONENT_LIB="VUE_COMPONENT_LIB"}(r||(r={}));var o=Object.freeze({__proto__:null,get NodeServices(){return i},get DataServiceTypes(){return t},get SelectionModes(){return s},get ExtensionTypes(){return n},get EventTypes(){return a},get ResourceTypes(){return r}});let c=0;const generateRequestId=()=>(c+=1,c),createJsonRpcRequest=(e,i=[])=>({jsonrpc:"2.0",method:e,params:i,id:generateRequestId()});const l="knimeUIExtension";var d=Object.freeze({__proto__:null,UI_EXT_POST_MESSAGE_PREFIX:l,UI_EXT_POST_MESSAGE_TIMEOUT:1e4});class IFrameKnimeService extends KnimeService{constructor(){super(),this.pendingServiceCalls=new Map,this.initializationPromise=new Promise((e=>{this.initializationPromiseResolve=e})),this.extensionConfig&&this.initializationPromiseResolve(),this.callableService=this.executeServiceCall,this.callablePushNotification=IFrameKnimeService.iframePushNotification,this.boundOnMessageFromParent=this.onMessageFromParent.bind(this),window.addEventListener("message",this.boundOnMessageFromParent),IFrameKnimeService.postMessage({messageType:"ready"})}async waitForInitialization(){await this.initializationPromise}onMessageFromParent(e){var i,t;const{data:s}=e;if(!(null===(i=s.type)||void 0===i?void 0:i.startsWith(l)))return;switch(null===(t=s.type)||void 0===t?void 0:t.replace("knimeUIExtension:","")){case"init":this.onInit(s);break;case"callServiceResponse":this.onCallServiceResponse(s);break;case"serviceNotification":this.onServiceNotification(s.payload)}}onInit(e){this.extensionConfig=e.payload,this.initializationPromiseResolve()}onCallServiceResponse(i){const{payload:{response:t,requestId:s}}=i,n=this.pendingServiceCalls.get(s);if(n)return n.resolve(t),void this.pendingServiceCalls.delete(s);const a=this.createAlert({code:"404",subtitle:"Request not found",type:e.ERROR,message:`Received callService response for non-existing pending request with id ${s}`});this.sendError(a)}executeServiceCall(i){let t;const s=generateRequestId(),n=new Promise(((i,n)=>{this.pendingServiceCalls.set(s,{resolve:i,reject:n}),t=setTimeout((()=>{const t=this.createAlert({code:"408",subtitle:"Request Timeout",type:e.ERROR,message:`Request with id ${s} aborted due to timeout.`});this.sendError(t),i(JSON.stringify({error:t}))}),1e4)}));return n.then((()=>{clearTimeout(t)})),IFrameKnimeService.postMessage({payload:{requestId:s,serviceParams:i},messageType:"callService"}),n}static postMessage(e){const{payload:i,messageType:t}=e;window.parent.postMessage({type:`knimeUIExtension:${t}`,payload:i},"*")}static iframePushNotification(e){return IFrameKnimeService.postMessage({payload:{notification:e},messageType:"notification"}),Promise.resolve()}destroy(){window.removeEventListener("message",this.boundOnMessageFromParent)}}const h=Object.assign({generateRequestId:generateRequestId,createJsonRpcRequest:createJsonRpcRequest},d);var v=Object.freeze({__proto__:null,KnimeTypes:o,KnimeService:KnimeService,JsonDataService:class JsonDataService{constructor(e){this.knimeService=e}callDataService(e,t=""){return this.knimeService.callService([i.CALL_NODE_DATA_SERVICE,e,t]).then((e=>"string"==typeof e&&""!==e?JSON.parse(e):e))}async initialData(){var e,i;let s;s=(null===(e=this.knimeService.extensionConfig)||void 0===e?void 0:e.initialData)?await Promise.resolve(null===(i=this.knimeService.extensionConfig)||void 0===i?void 0:i.initialData):await this.callDataService(t.INITIAL_DATA),"string"==typeof s&&(s=JSON.parse(s));const{result:n,warningMessages:a,userError:r,internalError:o}=s||{};return(r||o)&&this.handleError(r||o),a&&this.handleWarnings(a),Promise.resolve(n)}async data(e={}){const i=await this.callDataService(t.DATA,JSON.stringify(createJsonRpcRequest(e.method||"getData",e.options)));let s=(null==i?void 0:i.result)||{};"string"==typeof s&&(s=JSON.parse(s));const{error:n,warningMessages:a,result:r}=s;return n&&this.handleError(Object.assign(Object.assign({},n.data||{}),n)),a&&this.handleWarnings(a),Promise.resolve(r)}async applyData(){const e=await this.knimeService.getData();return this.callDataService(t.APPLY_DATA,e)}registerDataGetter(e){this.knimeService.registerDataGetter((()=>JSON.stringify(e())))}addOnDataChangeCallback(e){this.knimeService.addNotificationCallback(a.DataEvent,e)}publishData(e){this.knimeService.pushNotification({event:{data:e,method:a.DataEvent}})}handleError(i={}){const{details:t="",stackTrace:s="",typeName:n="",message:a="",code:r}=i;let o="",c="";if(a&&(a.length<=160?o=a:c=a),n&&(o?c=n:o=n),t&&(c=c?`${c}\n\n${t}`:t),Array.isArray(s)){const e=s.join("\n\t");c=c?`${c}\n\n${e}`:e}c=c.trim(),this.knimeService.sendError(this.knimeService.createAlert({subtitle:o||"Something went wrong",message:c||"No further information available. Please check the workflow configuration.",type:e.ERROR,code:r}))}handleWarnings(i){let t;const s=null==i?void 0:i.join("\n\n");(null==i?void 0:i.length)>1?t=`${null==i?void 0:i.length} messages`:(null==s?void 0:s.length)>160&&(t="Expand for details"),this.knimeService.sendWarning(this.knimeService.createAlert({type:e.WARN,message:s,subtitle:t}))}},IFrameKnimeService:IFrameKnimeService,IFrameKnimeServiceAdapter:class IFrameKnimeServiceAdapter extends KnimeService{constructor(e=null,i=null,t=null){super(e,i,t),this.boundOnMessageFromIFrame=this.onMessageFromIFrame.bind(this),window.addEventListener("message",this.boundOnMessageFromIFrame)}setIFrameWindow(e){this.iFrameWindow=e}updateEventListener(){window.removeEventListener("message",this.boundOnMessageFromIFrame),window.addEventListener("message",this.boundOnMessageFromIFrame)}checkMessageSource(e){return e.source!==this.iFrameWindow}async onMessageFromIFrame(e){var i;if(this.checkMessageSource(e))return;const{data:t}=e;switch(null===(i=t.type)||void 0===i?void 0:i.replace("knimeUIExtension:","")){case"ready":this.postMessage({payload:this.extensionConfig,messageType:"init"});break;case"callService":{const{payload:{requestId:e,serviceParams:i}}=t,s=await this.callService(i);this.postMessage({payload:{response:s,requestId:e},messageType:"callServiceResponse"})}break;case"notification":{const{payload:{notification:e}}=t;this.pushNotification(e)}}}onServiceNotification(e){const i="string"==typeof e?JSON.parse(e):e;this.postMessage({payload:i,messageType:"serviceNotification"})}destroy(){window.removeEventListener("message",this.boundOnMessageFromIFrame),this.iFrameWindow=null}postMessage(e){const{payload:i,messageType:t}=e;this.iFrameWindow.postMessage({type:`knimeUIExtension:${t}`,payload:i},"*")}},SelectionService:class SelectionService{constructor(e){this.knimeService=e}updateSelection(e,t){return this.knimeService.callService([i.CALL_NODE_SELECTION_SERVICE,e,Array.isArray(t)?JSON.stringify(t):t]).then((e=>"string"==typeof e?JSON.parse(e):e))}add(e){return this.updateSelection(s.ADD,e)}remove(e){return this.updateSelection(s.REMOVE,e)}replace(e){return this.updateSelection(s.REPLACE,e)}addOnSelectionChangeCallback(e){this.knimeService.addNotificationCallback(a.SelectionEvent,e)}removeOnSelectionChangeCallback(e){this.knimeService.removeNotificationCallback(a.SelectionEvent,e)}},KnimeUtils:h});return Object.defineProperty(window,"KnimeUIExtensionService",v),v}();
